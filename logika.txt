# Логика работы программы percentage_stop_loss_take_profit

1. Основная задача программы — мониторинг криптовалютных пар на фьючерсах Bybit, генерация торговых сигналов с динамическим расчетом уровней стоп-лосс (SL) и тейк-профит (TP), отправка сигналов в Telegram и сохранение их в базу данных Postgres.

2. Программа работает в многопоточном режиме: для каждой пары из списка SYMBOLS запускается отдельный поток мониторинга.

3. Для каждой пары:
   - Загружаются исторические данные (OHLCV) через ccxt.
   - Вычисляются индикаторы (EMA, MACD, ATR, RSI, Bollinger Bands, ADX и др.).
   - Определяется тренд на младшем (5m) и старшем (1h) таймфреймах.
   - Проверяется время суток (исключается азиатская ночь по UTC).
   - Оценивается волатильность (ATR/цена) и фильтруются сигналы при слишком низкой/высокой волатильности.
   - Генерируется сигнал на покупку (LONG) или продажу (SHORT) при выполнении условий (MACD пересечение, EMA-тренд, подтверждения индикаторов, свечные паттерны и др.).
   - Для каждого сигнала динамически рассчитываются уровни SL и TP с учетом ATR, swing-уровней, волатильности и заданных процентов.
   - Оценивается качество сигнала (сильный/средний/слабый) по количеству подтверждений и предупреждений.
   - Сигнал отправляется в Telegram и сохраняется в базу данных signals_sl_tp (Postgres) с подробной информацией (пара, направление, цены, проценты риска/прибыли, R/R, подтверждения, предупреждения, время).

4. Программа поддерживает асинхронную отправку сообщений в Telegram и безопасную работу с потоками.

5. В отдельном потоке ведется логирование средней рыночной волатильности (ATR/цена) по всем парам раз в час.

6. Все параметры (список пар, проценты SL/TP, множители ATR, R/R, лимиты, настройки Telegram и БД) задаются в начале bot.py и могут быть изменены пользователем.

# Итог: Программа — это торговый бот-сканер, который автоматически ищет сигналы по заданным критериям, рассчитывает уровни SL/TP, фильтрует по волатильности и тренду, отправляет сигналы в Telegram и сохраняет их в базу данных для дальнейшего анализа.

# Важно: создание таблицы signals_sl_tp должно быть выполнено вручную заранее, либо отдельным скриптом, так как метод CREATE TABLE IF NOT EXISTS не сработает, если у пользователя нет прав на создание таблиц в существующей базе. В рабочем режиме бот только вставляет новые сигналы в уже существующую таблицу.